# Database Interactions

This part describes the database schema and interactions used in the relayer.

## Schema

The relayer uses a SQLite database to store and manage transaction data. The database has three tables:

### ika_sign_requests

| Column | Data Type | Description |
|---|---|---|
| `id` | INTEGER | The ID of the IKA sign request (primary key) |
| `payload` | BLOB | The raw transaction data as a byte array |
| `dwallet_id` | TEXT | The ID of the dWallet used for signing |
| `user_sig` | TEXT | The user's signature on the transaction |
| `final_sig` | BLOB | The final signature generated by IKA (initially NULL) |
| `timestamp` | INTEGER | The timestamp of the request (Unix timestamp) |

### ika_txs

| Column | Data Type | Description |
|---|---|---|
| `sr_id` | INTEGER | The ID of the IKA sign request (foreign key to `ika_sign_requests`) |
| `status` | INTEGER | The status of the IKA transaction (0: Success, 1: Failed) |
| `ika_tx_id` | TEXT | The ID of the IKA transaction |
| `timestamp` | INTEGER | The timestamp of the IKA transaction (Unix timestamp) |
| `note` | TEXT |  Any notes or error messages related to the IKA transaction |
| **`sr_id`, `ika_tx_id`** | **Primary Key** |  The combination of `sr_id` and `ika_tx_id` uniquely identifies a row in this table | 

### bitcoin_txs

| Column | Data Type | Description |
|---|---|---|
| `sr_id` | INTEGER | The ID of the IKA sign request (foreign key to `ika_sign_requests`) |
| `status` | INTEGER | The status of the Bitcoin transaction (0: Pending, 1: Broadcasted, 2: Confirmed) |
| `btc_tx_id` | TEXT | The ID of the Bitcoin transaction (hash) |
| `timestamp` | INTEGER | The timestamp of the Bitcoin transaction (Unix timestamp) |
| `note` | TEXT | Any notes or error messages related to the Bitcoin transaction |
| **`sr_id`, `btc_tx_id`** | **Primary Key** | The combination of `sr_id` and `btc_tx_id` uniquely identifies a row in this table |

## Functions

The relayer interacts with the database using the following functions in the `dal` package:

### IKA Sign Requests

1. `InsertIkaSignRequest(request IkaSignRequest)`: Inserts a new IKA sign request into the `ika_sign_requests` table.
2. `GetIkaSignRequestByID(id uint64)`: Retrieves an IKA sign request by its ID.
3. `GetPendingIkaSignRequests()`: Retrieves all IKA sign requests that have not yet been successfully processed by IKA. This means the `final_sig` column in the `ika_sign_requests` table is NULL.
4. `UpdateIkaSignRequestFinalSig(id uint64, finalSig Signature)`: Updates the final signature of an IkaSignRequest in the database.
5. `GetSignedIkaSignRequests()`: Retrieves `IkaSignRequest`s that have been signed by IKA and have not yet been broadcasted to the Bitcoin network.

### IKA Transactions

1. `InsertIkaTx(tx IkaTx)`: Inserts a new IKA transaction into the `ika_txs` table.
2. `GetIkaTx(signRequestID uint64, ikaTxID string)`: Retrieves an IKA transaction by its primary key.

### Bitcoin Transactions

1. `InsertBitcoinTx(tx BitcoinTx)`: Inserts a new Bitcoin transaction into the `bitcoin_txs` table.
2. `GetBitcoinTx(signRequestID uint64, btcTxID []byte)`: Retrieves a Bitcoin transaction by its primary key.
3. `GetPendingBitcoinTxs()`: Retrieves all Bitcoin transactions with a "pending" status from the database.
4. `GetBroadcastedBitcoinTxs()`: Retrieves all Bitcoin transactions with a "broadcasted" status from the database.
5. `GetBroadcastedBitcoinTxsInfo()`: Retrieves `BitcoinTxInfo` for transactions with "Broadcasted" status that do not have a "Confirmed" status.
6. `UpdateBitcoinTxToConfirmed(id uint64, txID []byte)`: Updates the Bitcoin transaction to `Confirmed` status and updates its timestamp.
